<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.S. NAVY FLEET TRACKER - Google Sheet Test</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0f; color: #e0e0e0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; height: 100vh; }
        .container { display: grid; grid-template-columns: 1fr 360px; grid-template-rows: auto 1fr; height: 100vh; gap: 0; }
        .header { grid-column: 1 / -1; background: linear-gradient(180deg, #111118 0%, #0a0a0f 100%); border-bottom: 1px solid #1e1e2e; padding: 14px 28px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 20px; font-weight: 700; color: #00ff88; letter-spacing: 1px; }
        .logo-sub { font-size: 11px; font-weight: 500; color: #666; letter-spacing: 2px; margin-top: 2px; text-transform: uppercase; }
        .test-badge { background: #ff6b6b; color: #fff; font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 4px; margin-left: 12px; }
        .status-bar { display: flex; gap: 40px; }
        .stat { text-align: center; }
        .stat-value { font-size: 32px; font-weight: 700; color: #00ffff; }
        .stat-value.cvn { color: #ff6b6b; }
        .stat-value.amphib { color: #4ecdc4; }
        .stat-label { font-size: 10px; font-weight: 600; color: #555; letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
        .timestamp { font-size: 11px; color: #444; font-weight: 500; }
        .timestamp span { color: #00ff88; }
        .globe-container { background: #0a0a0f; position: relative; }
        #globe { width: 100%; height: 100%; }
        .side-panel { background: #0d0d14; border-left: 1px solid #1e1e2e; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 16px 20px; border-bottom: 1px solid #1e1e2e; }
        .panel-title { font-size: 12px; font-weight: 600; color: #00ff88; letter-spacing: 2px; text-transform: uppercase; }
        .ship-list { flex: 1; overflow-y: auto; padding: 12px; }
        .ship-list::-webkit-scrollbar { width: 5px; }
        .ship-list::-webkit-scrollbar-track { background: #0a0a0f; }
        .ship-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .location-group { margin-bottom: 16px; }
        .location-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(0, 255, 136, 0.05); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        .location-header:hover { background: rgba(0, 255, 136, 0.1); }
        .location-name { flex: 1; font-size: 12px; font-weight: 600; color: #00ff88; }
        .location-count { font-size: 11px; font-weight: 600; color: #888; background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 10px; }
        .ship-card { background: rgba(255, 255, 255, 0.02); border: 1px solid #1e1e2e; border-radius: 8px; margin-bottom: 6px; margin-left: 12px; padding: 12px 14px; cursor: pointer; transition: all 0.15s ease; }
        .ship-card:hover { border-color: #333; background: rgba(255, 255, 255, 0.04); }
        .ship-card.active { border-color: #00ffff; background: rgba(0, 255, 255, 0.08); }
        .ship-card.cvn { border-left: 3px solid #ff6b6b; }
        .ship-card.amphib { border-left: 3px solid #4ecdc4; }
        .ship-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .ship-hull { font-size: 14px; font-weight: 700; color: #fff; }
        .ship-hull.cvn { color: #ff6b6b; }
        .ship-hull.amphib { color: #4ecdc4; }
        .ship-type { font-size: 9px; font-weight: 600; padding: 3px 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.06); color: #888; }
        .ship-name { font-size: 12px; color: #777; font-weight: 500; }
        .ship-date { font-size: 10px; color: #444; margin-top: 4px; font-weight: 500; }
        .detail-panel { background: #111118; border-top: 1px solid #1e1e2e; padding: 16px; max-height: 280px; overflow-y: auto; }
        .detail-panel.hidden { display: none; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .detail-title { font-size: 15px; font-weight: 700; color: #00ffff; }
        .detail-close { cursor: pointer; color: #555; font-size: 18px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .detail-close:hover { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .detail-row { display: flex; margin-bottom: 8px; }
        .detail-label { width: 70px; font-size: 10px; font-weight: 600; color: #444; text-transform: uppercase; }
        .detail-value { flex: 1; font-size: 13px; color: #aaa; font-weight: 500; }
        .detail-status { font-size: 12px; color: #00ff88; line-height: 1.6; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; margin-top: 12px; }
        .filter-bar { padding: 12px 16px; border-bottom: 1px solid #1e1e2e; display: flex; gap: 8px; }
        .filter-btn { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; padding: 6px 14px; background: transparent; border: 1px solid #2a2a3a; color: #666; cursor: pointer; border-radius: 6px; transition: all 0.15s; }
        .filter-btn:hover { border-color: #444; color: #999; }
        .filter-btn.active { background: rgba(0, 255, 136, 0.1); border-color: #00ff88; color: #00ff88; }
        .attribution { padding: 10px 16px; border-top: 1px solid #1e1e2e; font-size: 10px; color: #444; text-align: center; }
        .btn-group { display: flex; gap: 12px; align-items: center; }
        .carrier-btn { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; padding: 10px 20px; background: linear-gradient(135deg, #ff6b6b 0%, #cc4444 100%); border: none; color: #fff; cursor: pointer; border-radius: 8px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); }
        .carrier-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4); }
        .cocom-dropdown { position: relative; }
        .cocom-btn { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; padding: 10px 20px; background: linear-gradient(135deg, #4ecdc4 0%, #2a9d8f 100%); border: none; color: #fff; cursor: pointer; border-radius: 8px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3); display: flex; align-items: center; gap: 8px; }
        .cocom-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(78, 205, 196, 0.4); }
        .cocom-btn::after { content: '▼'; font-size: 8px; }
        .cocom-menu { position: absolute; top: 100%; left: 0; margin-top: 8px; background: #111118; border: 1px solid #2a2a3a; border-radius: 10px; min-width: 180px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .cocom-dropdown.open .cocom-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .cocom-item { padding: 12px 16px; cursor: pointer; font-size: 12px; font-weight: 500; color: #888; transition: all 0.15s; border-bottom: 1px solid #1e1e2e; }
        .cocom-item:last-child { border-bottom: none; }
        .cocom-item:hover { background: rgba(78, 205, 196, 0.1); color: #4ecdc4; }
        .cocom-panel { position: absolute; bottom: 20px; left: 20px; background: rgba(17, 17, 24, 0.95); border: 1px solid #2a2a3a; border-radius: 12px; width: 320px; max-height: 300px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .cocom-panel.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .cocom-panel-header { padding: 14px 16px; border-bottom: 1px solid #1e1e2e; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, rgba(78, 205, 196, 0.1) 0%, transparent 100%); }
        .cocom-panel-title { font-size: 13px; font-weight: 700; color: #4ecdc4; }
        .cocom-panel-close { cursor: pointer; color: #555; font-size: 18px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .cocom-panel-close:hover { color: #ff6b6b; background: rgba(255,107,107,0.1); }
        .cocom-panel-body { padding: 12px; max-height: 240px; overflow-y: auto; }
        .cocom-ship { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .cocom-ship:hover { background: rgba(255,255,255,0.05); }
        .cocom-ship-icon { width: 8px; height: 8px; border-radius: 2px; }
        .cocom-ship-icon.cvn { background: #ff6b6b; }
        .cocom-ship-icon.amphib { background: #4ecdc4; }
        .cocom-ship-hull { font-size: 12px; font-weight: 600; color: #fff; width: 55px; }
        .cocom-ship-name { font-size: 11px; color: #666; flex: 1; }
        .cocom-ship-loc { font-size: 10px; color: #4ecdc4; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: #111118; border: 1px solid #2a2a3a; border-radius: 16px; width: 90%; max-width: 700px; max-height: 85vh; overflow: hidden; transform: scale(0.9); transition: transform 0.3s ease; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #1e1e2e; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, #1a1a22 0%, #111118 100%); }
        .modal-title { font-size: 18px; font-weight: 700; color: #ff6b6b; }
        .modal-subtitle { font-size: 11px; color: #666; margin-top: 4px; }
        .modal-close { cursor: pointer; color: #555; font-size: 24px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .modal-close:hover { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .modal-body { padding: 16px 24px 24px; overflow-y: auto; max-height: calc(85vh - 100px); }
        .carrier-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .carrier-item { background: rgba(255, 107, 107, 0.05); border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 10px; padding: 14px 16px; cursor: pointer; transition: all 0.15s; }
        .carrier-item:hover { background: rgba(255, 107, 107, 0.1); border-color: rgba(255, 107, 107, 0.4); transform: translateY(-2px); }
        .carrier-hull { font-size: 16px; font-weight: 700; color: #ff6b6b; margin-bottom: 4px; }
        .carrier-name { font-size: 12px; color: #888; margin-bottom: 8px; }
        .carrier-location { font-size: 11px; color: #00ff88; font-weight: 600; padding: 4px 10px; background: rgba(0, 255, 136, 0.1); border-radius: 4px; display: inline-block; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0a0a0f; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid #1e1e2e; border-top-color: #00ff88; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 14px; color: #00ff88; }
        .loading-subtext { margin-top: 8px; font-size: 11px; color: #666; }
        .error-message { color: #ff6b6b; font-size: 14px; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Fleet Data...</div>
        <div class="loading-subtext">Fetching from Google Sheets</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="header-left">
                <div>
                    <div class="logo">U.S. NAVY FLEET TRACKER <span class="test-badge">GSHEET TEST</span></div>
                    <div class="logo-sub">Carrier And Amphibious Assault Ship Tracker</div>
                </div>
            </div>
            <div class="status-bar">
                <div class="stat">
                    <div class="stat-value" id="totalCount">--</div>
                    <div class="stat-label">Total Ships</div>
                </div>
                <div class="stat">
                    <div class="stat-value cvn" id="cvnCount">--</div>
                    <div class="stat-label">Carriers</div>
                </div>
                <div class="stat">
                    <div class="stat-value amphib" id="amphibCount">--</div>
                    <div class="stat-label">Amphibs</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="btn-group">
                    <button class="carrier-btn" onclick="showCarrierModal()">Where are the carriers?</button>
                    <div class="cocom-dropdown" id="cocomDropdown">
                        <button class="cocom-btn" onclick="toggleCocomMenu()">By Theater</button>
                        <div class="cocom-menu">
                            <div class="cocom-item" onclick="selectCocom('INDOPACOM')">INDOPACOM</div>
                            <div class="cocom-item" onclick="selectCocom('CENTCOM')">CENTCOM</div>
                            <div class="cocom-item" onclick="selectCocom('EUCOM')">EUCOM</div>
                            <div class="cocom-item" onclick="selectCocom('SOUTHCOM')">SOUTHCOM</div>
                            <div class="cocom-item" onclick="selectCocom('CONUS')">CONUS</div>
                        </div>
                    </div>
                </div>
                <div class="timestamp">
                    Data Source: <span>Google Sheets</span>
                </div>
            </div>
        </header>
        <div class="globe-container">
            <div id="globe"></div>
            <div class="cocom-panel" id="cocomPanel">
                <div class="cocom-panel-header">
                    <div class="cocom-panel-title" id="cocomPanelTitle">INDOPACOM</div>
                    <span class="cocom-panel-close" onclick="closeCocomPanel()">&#x2715;</span>
                </div>
                <div class="cocom-panel-body" id="cocomPanelBody"></div>
            </div>
        </div>
        <div class="side-panel">
            <div class="panel-header">
                <div class="panel-title">Fleet Status</div>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="CVN">CVN</button>
                <button class="filter-btn" data-filter="LHA">LHA</button>
                <button class="filter-btn" data-filter="LHD">LHD</button>
            </div>
            <div class="ship-list" id="shipList"></div>
            <div class="detail-panel hidden" id="detailPanel">
                <div class="detail-header">
                    <div class="detail-title" id="detailTitle">-</div>
                    <span class="detail-close" onclick="closeDetail()">&#x2715;</span>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Class</div>
                    <div class="detail-value" id="detailClass">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Location</div>
                    <div class="detail-value" id="detailLocation">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Region</div>
                    <div class="detail-value" id="detailRegion">-</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">As Of</div>
                    <div class="detail-value" id="detailDate">-</div>
                </div>
                <div class="detail-status" id="detailStatus">-</div>
            </div>
            <div class="attribution">
                Created by @ianellisjones and IEJ Media<br>
                <span style="color: #4ecdc4;">Data: Google Sheets Integration Test</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="carrierModal" onclick="closeCarrierModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <div class="modal-title">WHERE ARE THE CARRIERS?</div>
                    <div class="modal-subtitle">Current positions of all U.S. Navy aircraft carriers</div>
                </div>
                <span class="modal-close" onclick="closeCarrierModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="carrier-grid" id="carrierGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheet CSV URL
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGU8xHLjpCXFMcv6WdRwIIIC_P4EHSkrrOBR-T_lKW9phqM-OTYXSZD9lmGk_87Csvxhn7t7Q-SttX/pub?gid=1036878474&output=csv';

        let shipsData = [];
        let activeFilter = 'all';
        let selectedShip = null;

        // COCOM definitions
        const cocomData = {
            'INDOPACOM': { name: 'Indo-Pacific Command', lat: 15, lon: 140, regions: ['WESTPAC', 'INDOPAC', 'PACIFIC', 'INDOPACOM'] },
            'CENTCOM': { name: 'Central Command', lat: 20, lon: 55, regions: ['CENTCOM'] },
            'EUCOM': { name: 'European Command', lat: 45, lon: 10, regions: ['EUCOM'] },
            'SOUTHCOM': { name: 'Southern Command', lat: 10, lon: -75, regions: ['SOUTHCOM'] },
            'CONUS': { name: 'Continental U.S.', lat: 35, lon: -100, regions: ['CONUS'] }
        };

        // Parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Fetch and parse Google Sheet data
        async function fetchSheetData() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());

                const ships = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const ship = {};
                    headers.forEach((h, idx) => {
                        ship[h] = values[idx] || '';
                    });

                    // Normalize field names and convert types
                    ships.push({
                        hull: ship.hull || '',
                        name: ship.name || '',
                        ship_class: ship.class || ship.ship_class || '',
                        ship_type: ship.type || ship.ship_type || '',
                        location: ship.location || '',
                        lat: parseFloat(ship.lat) || 0,
                        lon: parseFloat(ship.lon) || 0,
                        display_lat: parseFloat(ship.lat) || 0,
                        display_lon: parseFloat(ship.lon) || 0,
                        region: ship.region || 'CONUS',
                        date: ship.date || 'Unknown',
                        status: ship.status || 'Active'
                    });
                }

                return ships;
            } catch (error) {
                console.error('Error fetching sheet:', error);
                throw error;
            }
        }

        function initGlobe() {
            const cvnShips = shipsData.filter(s => s.ship_type === 'CVN');
            const amphibShips = shipsData.filter(s => s.ship_type !== 'CVN');

            const traces = [];

            if (cvnShips.length > 0) {
                traces.push({
                    type: 'scattergeo', mode: 'markers+text',
                    lat: cvnShips.map(s => s.lat), lon: cvnShips.map(s => s.lon),
                    text: cvnShips.map(s => s.hull), textposition: 'top center',
                    textfont: { family: 'Inter, sans-serif', size: 10, color: '#ff6b6b', weight: 600 },
                    hoverinfo: 'text', hovertext: cvnShips.map(s => `<b>${s.hull}</b><br>${s.name}<br>${s.location}`),
                    marker: { size: 12, color: '#ff6b6b', symbol: 'diamond', line: { width: 2, color: '#cc4444' } },
                    name: 'Carriers (CVN)', customdata: cvnShips
                });
            }

            if (amphibShips.length > 0) {
                traces.push({
                    type: 'scattergeo', mode: 'markers+text',
                    lat: amphibShips.map(s => s.lat), lon: amphibShips.map(s => s.lon),
                    text: amphibShips.map(s => s.hull), textposition: 'top center',
                    textfont: { family: 'Inter, sans-serif', size: 9, color: '#4ecdc4', weight: 600 },
                    hoverinfo: 'text', hovertext: amphibShips.map(s => `<b>${s.hull}</b><br>${s.name}<br>${s.location}`),
                    marker: { size: 10, color: '#4ecdc4', symbol: 'circle', line: { width: 2, color: '#2a9d8f' } },
                    name: 'Amphibious Assault Ships (LHA/LHD)', customdata: amphibShips
                });
            }

            const layout = {
                geo: {
                    projection: { type: 'orthographic', rotation: { lon: -100, lat: 25 } },
                    showland: true, landcolor: '#1a1a2e', showocean: true, oceancolor: '#0a0a0f',
                    showlakes: false, showrivers: false, showcountries: true, countrycolor: '#2a2a4e', countrywidth: 0.5,
                    showcoastlines: true, coastlinecolor: '#00ff88', coastlinewidth: 0.8, showframe: false, bgcolor: 'rgba(0,0,0,0)',
                    lonaxis: { showgrid: true, gridcolor: 'rgba(0, 255, 136, 0.08)', gridwidth: 0.5 },
                    lataxis: { showgrid: true, gridcolor: 'rgba(0, 255, 136, 0.08)', gridwidth: 0.5 }
                },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: true, legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(10, 10, 15, 0.9)', bordercolor: '#1e1e2e', borderwidth: 1, font: { family: 'Inter, sans-serif', size: 11, color: '#888' } },
                dragmode: 'pan'
            };

            const config = { responsive: true, displayModeBar: true, modeBarButtonsToRemove: ['toImage', 'sendDataToCloud'], displaylogo: false, scrollZoom: true };
            Plotly.newPlot('globe', traces, layout, config);

            document.getElementById('globe').on('plotly_click', function(data) {
                if (data.points && data.points.length > 0) {
                    const ship = data.points[0].customdata;
                    if (ship) {
                        showDetail(ship);
                        highlightShipCard(ship.hull);
                    }
                }
            });
        }

        function renderShipList() {
            const container = document.getElementById('shipList');
            const filtered = activeFilter === 'all' ? shipsData : shipsData.filter(s => s.ship_type === activeFilter);
            const grouped = {};
            filtered.forEach(ship => { if (!grouped[ship.location]) grouped[ship.location] = []; grouped[ship.location].push(ship); });
            const sortedLocations = Object.keys(grouped).sort((a, b) => grouped[b].length - grouped[a].length);
            let html = '';
            sortedLocations.forEach(location => {
                const ships = grouped[location];
                const count = ships.length;
                html += `<div class="location-group"><div class="location-header" onclick="rotateToLocation('${location}')"><span class="location-name">${location}</span><span class="location-count">${count} ship${count > 1 ? 's' : ''}</span></div>`;
                ships.forEach(ship => {
                    const typeClass = ship.ship_type === 'CVN' ? 'cvn' : 'amphib';
                    html += `<div class="ship-card ${typeClass}" data-hull="${ship.hull}" onclick="selectShip('${ship.hull}')"><div class="ship-header"><span class="ship-hull ${typeClass}">${ship.hull}</span><span class="ship-type">${ship.ship_type}</span></div><div class="ship-name">${ship.name}</div><div class="ship-date">As of ${ship.date}</div></div>`;
                });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function rotateToLocation(location) {
            const ship = shipsData.find(s => s.location === location);
            if (ship) Plotly.relayout('globe', { 'geo.projection.rotation.lon': ship.lon, 'geo.projection.rotation.lat': Math.max(-60, Math.min(60, ship.lat)) });
        }

        function selectShip(hull) {
            const ship = shipsData.find(s => s.hull === hull);
            if (ship) {
                showDetail(ship);
                highlightShipCard(hull);
                Plotly.relayout('globe', { 'geo.projection.rotation.lon': ship.lon, 'geo.projection.rotation.lat': Math.max(-60, Math.min(60, ship.lat)) });
            }
        }

        function highlightShipCard(hull) {
            document.querySelectorAll('.ship-card').forEach(card => card.classList.remove('active'));
            const card = document.querySelector(`.ship-card[data-hull="${hull}"]`);
            if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function showDetail(ship) {
            selectedShip = ship;
            document.getElementById('detailPanel').classList.remove('hidden');
            document.getElementById('detailTitle').textContent = `${ship.hull} - ${ship.name}`;
            document.getElementById('detailClass').textContent = `${ship.ship_class}-class ${ship.ship_type}`;
            document.getElementById('detailLocation').textContent = ship.location;
            document.getElementById('detailRegion').textContent = ship.region;
            document.getElementById('detailDate').textContent = ship.date;
            document.getElementById('detailStatus').textContent = ship.status;
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.add('hidden');
            document.querySelectorAll('.ship-card').forEach(card => card.classList.remove('active'));
            selectedShip = null;
        }

        function toggleCocomMenu() {
            document.getElementById('cocomDropdown').classList.toggle('open');
        }

        function selectCocom(cocom) {
            document.getElementById('cocomDropdown').classList.remove('open');
            const data = cocomData[cocom];
            Plotly.relayout('globe', { 'geo.projection.rotation.lon': data.lon, 'geo.projection.rotation.lat': data.lat });
            const cocomShips = shipsData.filter(s => data.regions.includes(s.region));
            document.getElementById('cocomPanelTitle').textContent = data.name + ' (' + cocomShips.length + ' ships)';
            let html = '';
            if (cocomShips.length === 0) {
                html = '<div style="color:#666;font-size:12px;padding:10px;">No ships currently in this theater</div>';
            } else {
                cocomShips.forEach(ship => {
                    const typeClass = ship.ship_type === 'CVN' ? 'cvn' : 'amphib';
                    html += `<div class="cocom-ship" onclick="selectShip('${ship.hull}')">
                        <div class="cocom-ship-icon ${typeClass}"></div>
                        <span class="cocom-ship-hull">${ship.hull}</span>
                        <span class="cocom-ship-name">${ship.name}</span>
                        <span class="cocom-ship-loc">${ship.location}</span>
                    </div>`;
                });
            }
            document.getElementById('cocomPanelBody').innerHTML = html;
            document.getElementById('cocomPanel').classList.add('visible');
        }

        function closeCocomPanel() {
            document.getElementById('cocomPanel').classList.remove('visible');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.cocom-dropdown')) {
                document.getElementById('cocomDropdown').classList.remove('open');
            }
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeFilter = this.dataset.filter;
                renderShipList();
            });
        });

        function showCarrierModal() {
            const carriers = shipsData.filter(s => s.ship_type === 'CVN').sort((a, b) => {
                const numA = parseInt(a.hull.replace('CVN', ''));
                const numB = parseInt(b.hull.replace('CVN', ''));
                return numA - numB;
            });
            const grid = document.getElementById('carrierGrid');
            grid.innerHTML = carriers.map(c => `
                <div class="carrier-item" onclick="selectCarrierFromModal('${c.hull}')">
                    <div class="carrier-hull">${c.hull}</div>
                    <div class="carrier-name">${c.name}</div>
                    <div class="carrier-location">${c.location}</div>
                </div>
            `).join('');
            document.getElementById('carrierModal').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeCarrierModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('carrierModal').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function selectCarrierFromModal(hull) {
            closeCarrierModal();
            selectShip(hull);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCarrierModal();
                closeCocomPanel();
            }
        });

        // Initialize
        async function init() {
            try {
                shipsData = await fetchSheetData();

                // Update counts
                const cvnCount = shipsData.filter(s => s.ship_type === 'CVN').length;
                const amphibCount = shipsData.filter(s => s.ship_type === 'LHA' || s.ship_type === 'LHD').length;
                document.getElementById('totalCount').textContent = shipsData.length;
                document.getElementById('cvnCount').textContent = cvnCount;
                document.getElementById('amphibCount').textContent = amphibCount;

                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.add('hidden');

                // Initialize components
                initGlobe();
                renderShipList();

                console.log(`Loaded ${shipsData.length} ships from Google Sheets`);
            } catch (error) {
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="error-message">
                        <h2 style="color: #ff6b6b; margin-bottom: 10px;">Failed to load data</h2>
                        <p>${error.message}</p>
                        <p style="margin-top: 20px; font-size: 12px; color: #666;">
                            Make sure the Google Sheet is published to web.<br>
                            File → Share → Publish to web → Sheet → CSV
                        </p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>
